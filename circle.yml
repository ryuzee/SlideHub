machine:
  services:
    - docker

  timezone:
    Asia/Tokyo

  ruby:
    version:
      2.2.3

  environment:
    CIRCLE_ENV: test
    OSS_DB_URL_TEST: 127.0.0.1
    OSS_REGION: ap-northeast-1
    OSS_SECRET_KEY_BASE: dummy

database:
  override:
    - bundle exec rake db:create db:migrate

deployment:
  hub:
    branch: production
    commands:
      - docker build -t ryuzee/openslideshare-v2:build-$CIRCLE_BUILD_NUM .
      - docker tag $(docker images -q | head -1) ryuzee/openslideshare-v2:latest
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASSWORD
      - docker push ryuzee/openslideshare-v2:build-$CIRCLE_BUILD_NUM
      - docker push ryuzee/openslideshare-v2:latest

